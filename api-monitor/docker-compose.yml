# =============================================================================
# API Monitor - Docker Compose Configuration
# =============================================================================
# This file sets up the complete development environment including:
# - PostgreSQL database
# - Spring Boot backend
# - React frontend
#
# Usage:
#   docker-compose up -d        # Start all services
#   docker-compose down         # Stop all services
#   docker-compose logs -f      # View logs
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: api-monitor-db
    environment:
      POSTGRES_DB: apimonitor
      POSTGRES_USER: apimonitor
      POSTGRES_PASSWORD: apimonitor123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apimonitor"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - api-monitor-network

  # ===========================================================================
  # Spring Boot Backend
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: api-monitor-backend
    environment:
      # Database
      DATABASE_URL: jdbc:postgresql://postgres:5432/apimonitor
      DATABASE_USERNAME: apimonitor
      DATABASE_PASSWORD: apimonitor123
      DATABASE_DRIVER: org.postgresql.Driver
      HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      JPA_DDL_AUTO: update
      
      # Security
      JWT_SECRET: your-super-secure-256-bit-jwt-secret-key-change-in-production
      ENCRYPTION_SECRET: your-32-character-encryption-key!
      
      # Email (configure for production)
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USERNAME: ""
      MAIL_PASSWORD: ""
      
      # Application
      SERVER_PORT: 8080
      LOG_LEVEL: INFO
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5173
      
      # Monitoring settings
      MONITORING_THREAD_POOL_SIZE: 20
      MAX_CONCURRENT_CHECKS: 100
      
      # H2 Console disabled in Docker
      H2_CONSOLE_ENABLED: "false"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - api-monitor-network

  # ===========================================================================
  # React Frontend
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: api-monitor-frontend
    environment:
      VITE_API_URL: http://localhost:8080/api
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - api-monitor-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  api-monitor-network:
    driver: bridge
